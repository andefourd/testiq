<div>
	<script
		nonce="csp_nonce"
		src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"
	></script>
	<script nonce="csp_nonce" type="text/javascript">
		if ('VKIDSDK' in window) {
			const VKID = window.VKIDSDK

			// Сначала запрашиваем code_challenge с сервера (теперь localhost)
			fetch('http://localhost:8080/init-pkce')
				.then(response => response.json())
				.then(data => {
					VKID.Config.init({
						app: 54437079,
						redirectUrl: 'https://oauth.vk.com/blank.html',
						responseMode: VKID.ConfigResponseMode.Callback,
						source: VKID.ConfigSource.LOWCODE,
						scope: 'vkid.personal_info,email', // Добавьте scopes, если нужны
						state: data.state, // State от сервера для ассоциации
						codeChallenge: data.code_challenge, // Code challenge от сервера
						codeChallengeMethod: 'S256', // Метод хэширования
					})
					const oneTap = new VKID.OneTap()
					oneTap
						.render({
							container: document.currentScript.parentElement,
							showAlternativeLogin: true,
						})
						.on(VKID.WidgetEvents.ERROR, vkidOnError)
						.on(VKID.OneTapInternalEvents.LOGIN_SUCCESS, function (payload) {
							const code = payload.code
							const deviceId = payload.device_id
							// Отправляем code, device_id и state на сервер для обмена (localhost)
							fetch('http://localhost:8080/exchange', {
								method: 'POST',
								headers: { 'Content-Type': 'application/json' },
								body: JSON.stringify({
									code: code,
									device_id: deviceId,
									state: data.state,
								}),
							})
								.then(response => response.json())
								.then(vkidOnSuccess)
								.catch(vkidOnError)
						})
				})
				.catch(vkidOnError)

			function vkidOnSuccess(data) {
				console.log('Успех:', data)
				// Обработка полученного результата (access_token, user_data и т.д.)
			}

			function vkidOnError(error) {
				console.error('Ошибка:', error)
			}
		}
	</script>
</div>
