<!doctype html>
<html lang="ru">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width,initial-scale=1" />
		<title>Клик-счетчик + VK Auth</title>
		<style>
			/* стили упрощены; можно оставить ваши */
			body {
				font-family: Arial, sans-serif;
				display: flex;
				align-items: center;
				justify-content: center;
				min-height: 100vh;
				margin: 0;
				background: #f0f2f5;
			}
			.card {
				background: white;
				padding: 30px;
				border-radius: 8px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
				text-align: center;
				width: 360px;
			}
			#counter {
				font-size: 48px;
				color: #2b6cb0;
				margin: 10px 0;
			}
			button {
				padding: 12px 20px;
				border-radius: 6px;
				border: none;
				background: #3182ce;
				color: white;
				font-weight: bold;
				cursor: pointer;
			}
			.vk-btn {
				background: #4c75a3;
				margin-top: 16px;
				display: block;
				width: 100%;
			}
			pre {
				text-align: left;
				background: #f7fafc;
				padding: 10px;
				border-radius: 6px;
				overflow: auto;
				max-height: 120px;
			}
		</style>
	</head>
	<body>
		<div class="card">
			<h2>Счетчик нажатий</h2>
			<div id="counter">0</div>
			<button id="clickBtn">НАЖМИ МЕНЯ!</button>
			<div style="margin-top: 12px">
				<button id="vkLogin" class="vk-btn">Войти через VK</button>
			</div>
			<h3 style="margin-top: 16px">Полученный access_token:</h3>
			<pre id="tokenBox">токен появится здесь после авторизации</pre>
		</div>

		<script>
			// Счётчик (localStorage)
			const counterDisplay = document.getElementById('counter')
			const clickBtn = document.getElementById('clickBtn')
			let count = parseInt(localStorage.getItem('myClicks') || '0', 10)
			counterDisplay.textContent = count
			clickBtn.addEventListener('click', () => {
				count++
				counterDisplay.textContent = count
				localStorage.setItem('myClicks', count)
			})

			// VK OAuth popup
			const vkBtn = document.getElementById('vkLogin')
			const tokenBox = document.getElementById('tokenBox')

			vkBtn.addEventListener('click', function () {
				// Открываем popup к локальному endpoint, который редиректит на VK
				const popup = window.open(
					'/vk/start',
					'vk_oauth',
					'width=600,height=700',
				)
				if (!popup) {
					alert('Popup заблокирован. Разрешите всплывающие окна для сайта.')
					return
				}
			})

			// Слушаем сообщение из popup
			window.addEventListener(
				'message',
				function (event) {
					// Проверяем origin — должен совпадать с текущим origin сайта
					if (event.origin !== location.origin) {
						console.warn('Неподходящий origin:', event.origin)
						return
					}
					const data = event.data || {}
					if (data.access_token) {
						// Выводим токен на страницу
						tokenBox.textContent = JSON.stringify(data, null, 2)

						// Также можно отправить этот токен на сервер (если требуется),
						// например: fetch('/save-token', {method:'POST', body: JSON.stringify(data)}) ...
					}
				},
				false,
			)
		</script>
	</body>
</html>
